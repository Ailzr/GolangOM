<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡ç›‘æ§ä¸­å¿ƒ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">æœåŠ¡ç›‘æ§ä¸­å¿ƒ</h1>
        <p class="text-gray-600 mt-2">å®æ—¶ç›‘æ§æœåŠ¡å™¨ä¸åº”ç”¨çŠ¶æ€</p>
    </header>

    <!-- æ–°å»ºæœåŠ¡å™¨æŒ‰é’® -->
    <div class="mb-6">
        <button id="create-server-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
            æ–°å»ºæœåŠ¡å™¨è¿æ¥
        </button>
    </div>

    <!-- æœåŠ¡å™¨åˆ—è¡¨ -->
    <div id="server-list" class="space-y-4">
        <!-- æœåŠ¡å™¨å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        <div id="loading-indicator" class="text-center text-blue-500 py-10 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2">æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>
        <div id="empty-state" class="text-center text-gray-500 py-10">
            æš‚æ— æœåŠ¡å™¨æ•°æ®ï¼Œè¯·æ·»åŠ æœåŠ¡å™¨ã€‚
        </div>
    </div>
</div>

<!-- æ–°å»º/ç¼–è¾‘æœåŠ¡å™¨æ¨¡æ€æ¡† -->
<div id="server-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
    <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-lg">
        <h2 id="server-modal-title" class="text-xl font-bold mb-4">æ–°å»ºæœåŠ¡å™¨</h2>
        <form id="server-form">
            <input type="hidden" id="server-id">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="server-ip">IP åœ°å€</label>
                <input type="text" id="server-ip" required class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="server-port">ç«¯å£</label>
                <input type="number" id="server-port" value="22" required class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="server-user">ç”¨æˆ·å</label>
                <input type="text" id="server-user" required class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="server-auth">è®¤è¯æ–¹å¼</label>
                <select id="server-auth" required class="w-full px-3 py-2 border rounded">
                    <option value="password">å¯†ç </option>
                    <option value="key">å¯†é’¥</option>
                </select>
            </div>
            <div id="password-group" class="mb-4">
                <label class="block text-gray-700 mb-2" for="server-password">å¯†ç </label>
                <input type="password" id="server-password" class="w-full px-3 py-2 border rounded">
            </div>
            <div id="key-group" class="mb-4 hidden">
                <label class="block text-gray-700 mb-2" for="server-credential">å¯†é’¥è·¯å¾„</label>
                <input type="text" id="server-credential" placeholder="/root/.ssh/id_rsa" class="w-full px-3 py-2 border rounded">
                <label class="block text-gray-700 mb-2 mt-2" for="server-key-password">å¯†é’¥å¯†ç  (å¯é€‰)</label>
                <input type="password" id="server-key-password" class="w-full px-3 py-2 border rounded">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancel-server-btn" class="px-4 py-2 border rounded hover:bg-gray-100">å–æ¶ˆ</button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">åˆ›å»º</button>
            </div>
        </form>
    </div>
</div>

<!-- æ–°å»º/ç¼–è¾‘åº”ç”¨æ¨¡æ€æ¡† -->
<div id="app-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
    <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-lg">
        <h2 id="app-modal-title" class="text-xl font-bold mb-4">æ–°å»ºåº”ç”¨</h2>
        <form id="app-form">
            <input type="hidden" id="app-id">
            <input type="hidden" id="app-server-id">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="app-name">åº”ç”¨åç§°</label>
                <input type="text" id="app-name" required class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="app-check-type">æ£€æŸ¥ç±»å‹</label>
                <select id="app-check-type" required class="w-full px-3 py-2 border rounded">
                    <option value="pid">è¿›ç¨‹å</option>
                    <option value="port">ç«¯å£</option>
                    <option value="http">HTTP</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="app-check-target">æ£€æŸ¥ç›®æ ‡</label>
                <input type="text" id="app-check-target" placeholder="å¦‚: myapp, 8080, http://..." required class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="app-check-interval">æ£€æŸ¥é—´éš” (ç§’)</label>
                <input type="number" id="app-check-interval" value="10" required class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="app-start-script">å¯åŠ¨è„šæœ¬è·¯å¾„</label>
                <input type="text" id="app-start-script" placeholder="/path/to/start.sh" required class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="app-auto-restart" class="mr-2">
                    <span class="text-gray-700">è‡ªåŠ¨é‡å¯</span>
                </label>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancel-app-btn" class="px-4 py-2 border rounded hover:bg-gray-100">å–æ¶ˆ</button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">åˆ›å»º</button>
            </div>
        </form>
    </div>
</div>

<!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
    <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-lg">
        <h2 class="text-xl font-bold mb-4 text-red-600">ç¡®è®¤åˆ é™¤</h2>
        <p id="confirm-message" class="text-gray-700 mb-6"></p>
        <div class="flex justify-end space-x-2">
            <button id="confirm-cancel-btn" class="px-4 py-2 border rounded hover:bg-gray-100">å–æ¶ˆ</button>
            <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">åˆ é™¤</button>
        </div>
    </div>
</div>

<script>
    // DOM å…ƒç´ 
    const serverListEl = document.getElementById('server-list');
    const serverModal = document.getElementById('server-modal');
    const appModal = document.getElementById('app-modal');
    const createServerBtn = document.getElementById('create-server-btn');
    const cancelServerBtn = document.getElementById('cancel-server-btn');
    const cancelAppBtn = document.getElementById('cancel-app-btn');
    const serverForm = document.getElementById('server-form');
    const appForm = document.getElementById('app-form');
    const serverAuthSelect = document.getElementById('server-auth');
    const passwordGroup = document.getElementById('password-group');
    const keyGroup = document.getElementById('key-group');
    const loadingIndicator = document.getElementById('loading-indicator');
    const emptyState = document.getElementById('empty-state');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

    // æ•°æ®ç¼“å­˜
    let servers = [];
    let appsMap = new Map(); // appMap[serverId] = [apps]
    let expandedServers = new Set(); // è®°å½•å±•å¼€çš„æœåŠ¡å™¨ID

    // API åŸºç¡€åœ°å€ - åŠ¨æ€è·å–å½“å‰é¡µé¢çš„ä¸»æœºå’Œç«¯å£
    const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;

    // çŠ¶æ€ç®¡ç†å‡½æ•°
    function showLoadingState() {
        loadingIndicator.classList.remove('hidden');
        emptyState.classList.add('hidden');
        serverListEl.innerHTML = '';
        serverListEl.appendChild(loadingIndicator);
    }

    function showErrorState(message) {
        loadingIndicator.classList.add('hidden');
        emptyState.classList.add('hidden');
        serverListEl.innerHTML = `<div class="text-center text-red-500 py-10">${message}</div>`;
    }

    function hideLoadingState() {
        loadingIndicator.classList.add('hidden');
    }

    // é€šçŸ¥ç³»ç»Ÿ
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoadingState();
            
            // 2. ä½¿ç”¨ await ç­‰å¾…æœåŠ¡å™¨åˆ—è¡¨åŠ è½½å®Œæˆ
            await fetchServerList();

            // 3. åœ¨æœåŠ¡å™¨åˆ—è¡¨åŠ è½½å®Œæˆåï¼Œå†ç­‰å¾…åº”ç”¨åˆ—è¡¨åŠ è½½å®Œæˆ
            await fetchAppList();

            // 4. ç¡®è®¤ä¸¤ä¸ªåˆ—è¡¨éƒ½åŠ è½½æˆåŠŸåï¼Œå†æ‰§è¡Œæ¸²æŸ“
            renderServerList();

            // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
            initWebSocket();
            setupEventListeners();
        } catch (error) {
            console.error('åˆå§‹åŒ–æ•°æ®åŠ è½½å¤±è´¥:', error);
            showErrorState('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
        }
    });

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // æ–°å»ºæœåŠ¡å™¨æŒ‰é’®
        createServerBtn.addEventListener('click', () => {
            // é‡ç½®ä¸ºæ–°å»ºæ¨¡å¼
            document.getElementById('server-modal-title').textContent = 'æ–°å»ºæœåŠ¡å™¨';
            document.getElementById('server-id').value = '';
            serverForm.reset();
            serverModal.classList.remove('hidden');
        });

        // å–æ¶ˆæœåŠ¡å™¨åˆ›å»º
        cancelServerBtn.addEventListener('click', () => {
            serverModal.classList.add('hidden');
            serverForm.reset();
        });

        // å–æ¶ˆåº”ç”¨åˆ›å»º
        cancelAppBtn.addEventListener('click', () => {
            appModal.classList.add('hidden');
            appForm.reset();
        });

        // å–æ¶ˆç¡®è®¤åˆ é™¤
        confirmCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });

        // è®¤è¯æ–¹å¼åˆ‡æ¢
        serverAuthSelect.addEventListener('change', () => {
            if (serverAuthSelect.value === 'password') {
                passwordGroup.classList.remove('hidden');
                keyGroup.classList.add('hidden');
            } else {
                passwordGroup.classList.add('hidden');
                keyGroup.classList.remove('hidden');
            }
        });

        // æäº¤æœåŠ¡å™¨è¡¨å•
        serverForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const serverId = document.getElementById('server-id').value;
            const serverData = {
                ip: document.getElementById('server-ip').value,
                port: parseInt(document.getElementById('server-port').value),
                user: document.getElementById('server-user').value,
                auth_method: document.getElementById('server-auth').value,
                password: document.getElementById('server-password').value,
                credential: document.getElementById('server-credential').value,
            };
            
            if (serverData.auth_method === 'key') {
                serverData.password = document.getElementById('server-key-password').value;
            }
            
            if (serverId) {
                // ç¼–è¾‘æ¨¡å¼
                serverData.id = parseInt(serverId);
                await updateServer(serverData);
            } else {
                // æ–°å»ºæ¨¡å¼
                await createServer(serverData);
            }
        });

        // æäº¤åº”ç”¨è¡¨å•
        appForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const appId = document.getElementById('app-id').value;
            const appData = {
                server_id: parseInt(document.getElementById('app-server-id').value),
                name: document.getElementById('app-name').value,
                check_type: document.getElementById('app-check-type').value,
                check_target: document.getElementById('app-check-target').value,
                check_interval: parseInt(document.getElementById('app-check-interval').value),
                start_script: document.getElementById('app-start-script').value,
                auto_restart: document.getElementById('app-auto-restart').checked,
            };
            
            if (appId) {
                // ç¼–è¾‘æ¨¡å¼
                appData.id = parseInt(appId);
                await updateApp(appData);
            } else {
                // æ–°å»ºæ¨¡å¼
                await createApp(appData);
            }
        });
    }

    // è·å–æœåŠ¡å™¨åˆ—è¡¨
    async function fetchServerList() {
        const response = await fetch(`${API_BASE_URL}/server/list`, {
            credentials: 'include' // æºå¸¦Cookie
        });
        if (!response.ok) throw new Error('è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥');
        const data = await response.json();
        if (data.code === 200) {
            servers = data.data.servers;
        } else {
            throw new Error(data.msg || 'è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥');
        }
    }

    // è·å–åº”ç”¨åˆ—è¡¨
    async function fetchAppList() {
        const response = await fetch(`${API_BASE_URL}/app/list`, {
            credentials: 'include' // æºå¸¦Cookie
        });
        if (!response.ok) throw new Error('è·å–åº”ç”¨åˆ—è¡¨å¤±è´¥');
        const data = await response.json();
        if (data.code === 200) {
            const apps = data.data.apps;
            appsMap.clear(); // å…ˆæ¸…ç©ºï¼Œé˜²æ­¢æ•°æ®é‡å¤
            apps.forEach(app => {
                if (!appsMap.has(app.server_id)) {
                    appsMap.set(app.server_id, []);
                }
                appsMap.get(app.server_id).push(app);
            });
        } else {
            throw new Error(data.msg || 'è·å–åº”ç”¨åˆ—è¡¨å¤±è´¥');
        }
    }

    // åˆ›å»ºæœåŠ¡å™¨
    async function createServer(serverData) {
        try {
            const response = await fetch(`${API_BASE_URL}/server/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(serverData),
                credentials: 'include' // æºå¸¦Cookie
            });
            if (!response.ok) throw new Error('åˆ›å»ºæœåŠ¡å™¨å¤±è´¥');
            const data = await response.json();
            if (data.code === 200) {
                showNotification('æœåŠ¡å™¨åˆ›å»ºæˆåŠŸï¼', 'success');
                serverModal.classList.add('hidden');
                serverForm.reset();
                await fetchServerList(); // åˆ·æ–°åˆ—è¡¨
                renderServerList();
            } else {
                showNotification(`åˆ›å»ºå¤±è´¥: ${data.msg}`, 'error');
            }
        } catch (error) {
            console.error('Error creating server:', error);
            showNotification('åˆ›å»ºæœåŠ¡å™¨æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // åˆ›å»ºåº”ç”¨
    async function createApp(appData) {
        try {
            const response = await fetch(`${API_BASE_URL}/app/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(appData),
                credentials: 'include' // æºå¸¦Cookie
            });
            if (!response.ok) throw new Error('åˆ›å»ºåº”ç”¨å¤±è´¥');
            const data = await response.json();
            if (data.code === 200) {
                showNotification('åº”ç”¨åˆ›å»ºæˆåŠŸï¼', 'success');
                appModal.classList.add('hidden');
                appForm.reset();
                await fetchAppList(); // åˆ·æ–°åˆ—è¡¨
                renderServerList();
            } else {
                showNotification(`åˆ›å»ºå¤±è´¥: ${data.msg}`, 'error');
            }
        } catch (error) {
            console.error('Error creating app:', error);
            showNotification('åˆ›å»ºåº”ç”¨æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // æ¸²æŸ“æœåŠ¡å™¨åˆ—è¡¨
    function renderServerList() {
        hideLoadingState();
        
        if (servers.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');

        serverListEl.innerHTML = '';
        servers.forEach(server => {
            const apps = appsMap.get(server.id) || [];
            const isConnected = server.check_result === 'connected';
            const serverCard = document.createElement('div');
            serverCard.className = 'bg-white rounded-lg shadow-sm overflow-hidden';
            serverCard.innerHTML = `
                    <div class="p-4 cursor-pointer server-header" data-server-id="${server.id}">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-lg">${server.ip}:${server.port}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${isConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
                                </span>
                                <button class="text-blue-500 hover:text-blue-700 text-sm edit-server-btn" data-server-id="${server.id}" title="ç¼–è¾‘æœåŠ¡å™¨">
                                    <i>âœï¸</i>
                                </button>
                                <button class="text-red-500 hover:text-red-700 text-sm delete-server-btn" data-server-id="${server.id}" title="åˆ é™¤æœåŠ¡å™¨">
                                    <i>ğŸ—‘ï¸</i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <p>è®¤è¯æ–¹å¼: ${server.auth_method === 'password' ? 'å¯†ç ' : 'å¯†é’¥'}</p>
                            <p>ä¸Šæ¬¡æ£€æŸ¥: ${new Date(server.check_time).toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="border-t border-gray-100 server-apps ${expandedServers.has(server.id) ? '' : 'hidden'}">
                        <div class="p-4 border-b border-gray-100">
                            <button class="text-blue-500 hover:text-blue-700 text-sm create-app-btn" data-server-id="${server.id}">
                                <i>+</i> æ–°å»ºåº”ç”¨
                            </button>
                        </div>
                        <div class="divide-y divide-gray-100">
                            ${apps.length > 0 ? apps.map(app => `
                                <div class="p-4 flex justify-between items-center">
                                    <div>
                                        <h4 class="font-medium">${app.name}</h4>
                                        <p class="text-sm text-gray-600">ç±»å‹: ${getCheckTypeName(app.check_type)}, ç›®æ ‡: ${app.check_target}</p>
                                        <p class="text-sm text-gray-600">å¯åŠ¨è„šæœ¬: ${app.start_script}</p>
                                        <p class="text-sm text-gray-600">ä¸Šæ¬¡æ£€æŸ¥: ${new Date(app.last_check_time).toLocaleString()}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${app.check_result ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${app.check_result ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
                                        </span>
                                        <button class="text-blue-500 hover:text-blue-700 text-sm edit-app-btn" data-app-id="${app.id}" title="ç¼–è¾‘åº”ç”¨">
                                            <i>âœï¸</i>
                                        </button>
                                        <button class="text-red-500 hover:text-red-700 text-sm delete-app-btn" data-app-id="${app.id}" title="åˆ é™¤åº”ç”¨">
                                            <i>ğŸ—‘ï¸</i>
                                        </button>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="p-4 text-center text-gray-500">
                                    æš‚æ— åº”ç”¨ï¼Œè¯·ä¸ºè¯¥æœåŠ¡å™¨æ·»åŠ åº”ç”¨ã€‚
                                </div>
                            `}
                        </div>
                    </div>
                `;
            serverListEl.appendChild(serverCard);
        });

        // ä¸ºæœåŠ¡å™¨æ ‡é¢˜æ·»åŠ ç‚¹å‡»å±•å¼€/æŠ˜å äº‹ä»¶
        document.querySelectorAll('.server-header').forEach(header => {
            header.addEventListener('click', () => {
                const serverId = parseInt(header.getAttribute('data-server-id'));
                const appsEl = header.nextElementSibling;
                const isHidden = appsEl.classList.contains('hidden');
                
                if (isHidden) {
                    appsEl.classList.remove('hidden');
                    expandedServers.add(serverId);
                } else {
                    appsEl.classList.add('hidden');
                    expandedServers.delete(serverId);
                }
            });
        });

        // ä¸ºæ–°å»ºåº”ç”¨æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.create-app-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘æœåŠ¡å™¨æ ‡é¢˜çš„ç‚¹å‡»äº‹ä»¶
                const serverId = btn.getAttribute('data-server-id');
                
                // é‡ç½®ä¸ºæ–°å»ºæ¨¡å¼
                document.getElementById('app-modal-title').textContent = 'æ–°å»ºåº”ç”¨';
                document.getElementById('app-id').value = '';
                document.getElementById('app-server-id').value = serverId;
                appForm.reset();
                document.getElementById('app-server-id').value = serverId; // é‡æ–°è®¾ç½®æœåŠ¡å™¨ID
                appModal.classList.remove('hidden');
            });
        });

        // ä¸ºç¼–è¾‘æœåŠ¡å™¨æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.edit-server-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘æœåŠ¡å™¨æ ‡é¢˜çš„ç‚¹å‡»äº‹ä»¶
                const serverId = btn.getAttribute('data-server-id');
                editServer(serverId);
            });
        });

        // ä¸ºåˆ é™¤æœåŠ¡å™¨æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.delete-server-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘æœåŠ¡å™¨æ ‡é¢˜çš„ç‚¹å‡»äº‹ä»¶
                const serverId = btn.getAttribute('data-server-id');
                const server = servers.find(s => s.id == serverId);
                if (server) {
                    deleteServer(serverId, server.ip, server.port);
                }
            });
        });

        // ä¸ºç¼–è¾‘åº”ç”¨æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.edit-app-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘å…¶ä»–äº‹ä»¶
                const appId = btn.getAttribute('data-app-id');
                editApp(appId);
            });
        });

        // ä¸ºåˆ é™¤åº”ç”¨æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.delete-app-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘å…¶ä»–äº‹ä»¶
                const appId = btn.getAttribute('data-app-id');
                // æ‰¾åˆ°å¯¹åº”çš„åº”ç”¨
                let app = null;
                for (const [serverId, apps] of appsMap.entries()) {
                    const foundApp = apps.find(a => a.id == appId);
                    if (foundApp) {
                        app = foundApp;
                        break;
                    }
                }
                if (app) {
                    deleteApp(appId, app.name);
                }
            });
        });
    }

    // æ ¹æ®æ£€æŸ¥ç±»å‹è·å–ä¸­æ–‡åç§°
    function getCheckTypeName(type) {
        const map = { 'pid': 'è¿›ç¨‹', 'port': 'ç«¯å£', 'http': 'HTTP' };
        return map[type] || type;
    }

    // ç¼–è¾‘æœåŠ¡å™¨
    async function editServer(serverId) {
        try {
            const response = await fetch(`${API_BASE_URL}/server/get`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: parseInt(serverId) }),
                credentials: 'include'
            });

            if (!response.ok) throw new Error('è·å–æœåŠ¡å™¨ä¿¡æ¯å¤±è´¥');
            const data = await response.json();
            
            if (data.code === 200) {
                const server = data.data.server;
                
                // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
                document.getElementById('server-modal-title').textContent = 'ç¼–è¾‘æœåŠ¡å™¨';
                
                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('server-id').value = server.id;
                document.getElementById('server-ip').value = server.ip;
                document.getElementById('server-port').value = server.port;
                document.getElementById('server-user').value = server.user;
                document.getElementById('server-auth').value = server.auth_method;
                
                // æ ¹æ®è®¤è¯æ–¹å¼æ˜¾ç¤ºç›¸åº”å­—æ®µ
                if (server.auth_method === 'password') {
                    passwordGroup.classList.remove('hidden');
                    keyGroup.classList.add('hidden');
                } else {
                    passwordGroup.classList.add('hidden');
                    keyGroup.classList.remove('hidden');
                }
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                serverModal.classList.remove('hidden');
            } else {
                showNotification(`è·å–æœåŠ¡å™¨ä¿¡æ¯å¤±è´¥: ${data.msg}`, 'error');
            }
        } catch (error) {
            console.error('Error fetching server:', error);
            showNotification('è·å–æœåŠ¡å™¨ä¿¡æ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // æ›´æ–°æœåŠ¡å™¨
    async function updateServer(serverData) {
        try {
            const response = await fetch(`${API_BASE_URL}/server/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(serverData),
                credentials: 'include'
            });

            if (!response.ok) throw new Error('æ›´æ–°æœåŠ¡å™¨å¤±è´¥');
            const data = await response.json();
            
            if (data.code === 200) {
                showNotification('æœåŠ¡å™¨æ›´æ–°æˆåŠŸï¼', 'success');
                serverModal.classList.add('hidden');
                serverForm.reset();
                await fetchServerList();
                renderServerList();
            } else {
                showNotification(`æ›´æ–°å¤±è´¥: ${data.msg}`, 'error');
            }
        } catch (error) {
            console.error('Error updating server:', error);
            showNotification('æ›´æ–°æœåŠ¡å™¨æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // ç¼–è¾‘åº”ç”¨
    async function editApp(appId) {
        try {
            const response = await fetch(`${API_BASE_URL}/app/get`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: parseInt(appId) }),
                credentials: 'include'
            });

            if (!response.ok) throw new Error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥');
            const data = await response.json();
            
            if (data.code === 200) {
                const app = data.data.app;
                
                // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
                document.getElementById('app-modal-title').textContent = 'ç¼–è¾‘åº”ç”¨';
                
                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('app-id').value = app.id;
                document.getElementById('app-server-id').value = app.server_id;
                document.getElementById('app-name').value = app.name;
                document.getElementById('app-check-type').value = app.check_type;
                document.getElementById('app-check-target').value = app.check_target;
                document.getElementById('app-check-interval').value = app.check_interval;
                document.getElementById('app-start-script').value = app.start_script;
                document.getElementById('app-auto-restart').checked = app.auto_restart;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                appModal.classList.remove('hidden');
            } else {
                showNotification(`è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥: ${data.msg}`, 'error');
            }
        } catch (error) {
            console.error('Error fetching app:', error);
            showNotification('è·å–åº”ç”¨ä¿¡æ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // æ›´æ–°åº”ç”¨
    async function updateApp(appData) {
        try {
            const response = await fetch(`${API_BASE_URL}/app/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(appData),
                credentials: 'include'
            });

            if (!response.ok) throw new Error('æ›´æ–°åº”ç”¨å¤±è´¥');
            const data = await response.json();
            
            if (data.code === 200) {
                showNotification('åº”ç”¨æ›´æ–°æˆåŠŸï¼', 'success');
                appModal.classList.add('hidden');
                appForm.reset();
                await fetchAppList();
                renderServerList();
            } else {
                showNotification(`æ›´æ–°å¤±è´¥: ${data.msg}`, 'error');
            }
        } catch (error) {
            console.error('Error updating app:', error);
            showNotification('æ›´æ–°åº”ç”¨æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // åˆ é™¤æœåŠ¡å™¨
    function deleteServer(serverId, serverIp, serverPort) {
        confirmMessage.textContent = `ç¡®å®šè¦åˆ é™¤æœåŠ¡å™¨ ${serverIp}:${serverPort} å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤æœåŠ¡å™¨ä¼šåŒæ—¶åˆ é™¤è¯¥æœåŠ¡å™¨ä¸‹çš„æ‰€æœ‰åº”ç”¨ï¼`;
        confirmModal.classList.remove('hidden');
        
        // è®¾ç½®ç¡®è®¤åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        confirmDeleteBtn.onclick = async () => {
            confirmModal.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/server/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: parseInt(serverId) }),
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('åˆ é™¤æœåŠ¡å™¨å¤±è´¥');
                const data = await response.json();
                
                if (data.code === 200) {
                    showNotification('æœåŠ¡å™¨åˆ é™¤æˆåŠŸï¼', 'success');
                    // åˆ·æ–°æ•°æ®
                    await fetchServerList();
                    await fetchAppList();
                    renderServerList();
                } else {
                    showNotification(`åˆ é™¤å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting server:', error);
                showNotification('åˆ é™¤æœåŠ¡å™¨æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            }
        };
    }

    // åˆ é™¤åº”ç”¨
    function deleteApp(appId, appName) {
        confirmMessage.textContent = `ç¡®å®šè¦åˆ é™¤åº”ç”¨ "${appName}" å—ï¼Ÿ`;
        confirmModal.classList.remove('hidden');
        
        // è®¾ç½®ç¡®è®¤åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        confirmDeleteBtn.onclick = async () => {
            confirmModal.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/app/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: parseInt(appId) }),
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('åˆ é™¤åº”ç”¨å¤±è´¥');
                const data = await response.json();
                
                if (data.code === 200) {
                    showNotification('åº”ç”¨åˆ é™¤æˆåŠŸï¼', 'success');
                    // åˆ·æ–°æ•°æ®
                    await fetchAppList();
                    renderServerList();
                } else {
                    showNotification(`åˆ é™¤å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting app:', error);
                showNotification('åˆ é™¤åº”ç”¨æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            }
        };
    }

    // åˆå§‹åŒ– WebSocket è¿æ¥
    function initWebSocket() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUri = `${wsProtocol}//${window.location.host}/api/ws`;
        const socket = new WebSocket(wsUri);

        socket.onopen = () => {
            console.log('WebSocket è¿æ¥å·²å»ºç«‹');
        };

        socket.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                console.log('æ”¶åˆ° WebSocket æ¶ˆæ¯:', message);

                // æ ¹æ®æ¶ˆæ¯æ›´æ–° UI
                if (message.server_id !== 0) {
                    // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
                    const serverIndex = servers.findIndex(s => s.id === message.server_id);
                    if (serverIndex !== -1) {
                        console.log(`æ›´æ–°å‰æœåŠ¡å™¨ ${message.server_id} çŠ¶æ€: ${servers[serverIndex].check_result}`);
                        servers[serverIndex].check_result = message.server_status;
                        servers[serverIndex].check_time = new Date().toISOString();
                        console.log(`æ›´æ–°åæœåŠ¡å™¨ ${message.server_id} çŠ¶æ€: ${servers[serverIndex].check_result}`);
                    } else {
                        console.log(`æœªæ‰¾åˆ°æœåŠ¡å™¨ ID: ${message.server_id}`);
                    }
                }

                if (message.app_id !== 0) {
                    // æ›´æ–°åº”ç”¨çŠ¶æ€
                    let found = false;
                    for (const [serverId, apps] of appsMap.entries()) {
                        const appIndex = apps.findIndex(a => a.id === message.app_id);
                        if (appIndex !== -1) {
                            console.log(`æ›´æ–°å‰åº”ç”¨ ${message.app_id} çŠ¶æ€: ${apps[appIndex].check_result}`);
                            apps[appIndex].check_result = message.app_status;
                            apps[appIndex].last_check_time = new Date().toISOString();
                            console.log(`æ›´æ–°ååº”ç”¨ ${message.app_id} çŠ¶æ€: ${apps[appIndex].check_result}`);
                            found = true;
                            break; // æ‰¾åˆ°åè·³å‡ºå¾ªç¯
                        }
                    }
                    if (!found) {
                        console.log(`æœªæ‰¾åˆ°åº”ç”¨ ID: ${message.app_id}`);
                    }
                }

                // é‡æ–°æ¸²æŸ“ä»¥åæ˜ çŠ¶æ€å˜åŒ–
                console.log('é‡æ–°æ¸²æŸ“æœåŠ¡å™¨åˆ—è¡¨ï¼Œå½“å‰å±•å¼€çŠ¶æ€:', Array.from(expandedServers));
                renderServerList();

            } catch (error) {
                console.error('è§£æ WebSocket æ¶ˆæ¯å¤±è´¥:', error);
            }
        };

        socket.onclose = (event) => {
            console.log('WebSocket è¿æ¥å·²å…³é—­', event.code, event.reason);
            if (event.code !== 1000) { // éæ­£å¸¸å…³é—­
                console.log('å°†åœ¨ 3 ç§’åå°è¯•é‡è¿...');
                setTimeout(initWebSocket, 3000);
            }
        };

        socket.onerror = (error) => {
            console.error('WebSocket å‘ç”Ÿé”™è¯¯:', error);
            showNotification('WebSocketè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        };
    }
</script>
</body>
</html>